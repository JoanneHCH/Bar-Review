<h2 class="mb-3">Edit Bar</h2>

<form action="/bars/<%= bar._id %>?_method=PUT" method="POST" enctype="multipart/form-data">
  <div class="mb-2">
    <label>Name:</label>
    <input type="text" name="name" value="<%= bar.name %>" class="form-control" required>
  </div>

  <div class="mb-2">
    <label>Location (searchable address):</label>
    <input id="autocomplete" type="text" name="location"
           value="<%= bar.location || '' %>"
           class="form-control"
           placeholder="Enter a location to search..." required>
  </div>

  <!-- Map -->
  <div id="map" style="width: 100%; height: 400px; border-radius: 10px; margin-bottom: 12px;"></div>

  <!-- Hidden coordinate fields -->
  <input type="hidden" name="latitude" id="latitude" value="<%= bar.latitude || '' %>">
  <input type="hidden" name="longitude" id="longitude" value="<%= bar.longitude || '' %>">

<div class="mb-2">
  <label>Rating:</label>
  <select name="rating" class="form-select">
    <option value="">Select a rating</option>
    <option value="1" <%= bar.rating == 1 ? 'selected' : '' %>>1 / 5</option>
    <option value="2" <%= bar.rating == 2 ? 'selected' : '' %>>2 / 5</option>
    <option value="3" <%= bar.rating == 3 ? 'selected' : '' %>>3 / 5</option>
    <option value="4" <%= bar.rating == 4 ? 'selected' : '' %>>4 / 5</option>
    <option value="5" <%= bar.rating == 5 ? 'selected' : '' %>>5 / 5</option>
  </select>
</div>

  <div class="mb-2">
    <label>Description:</label>
    <textarea name="description" class="form-control" rows="3"><%= bar.description || '' %></textarea>
  </div>

  <hr class="my-4">

  <h5 class="mt-2">ðŸ“¸ Current Images</h5>
  <% if (bar.images && bar.images.length > 0) { %>
    <div class="row">
      <% bar.images.forEach(img => { %>
        <div class="col-md-3 col-6 text-center mb-3">
          <img src="<%= img.url %>" class="img-fluid rounded shadow-sm mb-2"
               style="max-height: 180px; object-fit: cover;">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="deleteImages"
                   value="<%= img.filename %>" id="del-<%= img.filename %>">
            <label class="form-check-label" for="del-<%= img.filename %>">Delete this image</label>
          </div>
        </div>
      <% }) %>
    </div>
  <% } else { %>
    <p class="text-muted">No images uploaded yet</p>
  <% } %>

  <div class="mb-3 mt-2">
    <label>Upload New Images (multiple allowed):</label>
    <input type="file" name="images" multiple class="form-control">
  </div>

  <div class="d-flex gap-2 mt-3">
    <button type="submit" class="btn btn-secondary">Update</button>
    <a href="/bars/<%= bar._id %>" class="btn btn-secondary">Cancel</a>
  </div>
</form>

<!-- Google Maps (Places Autocomplete) -->
<script async
  src="https://maps.googleapis.com/maps/api/js?key=<%= GOOGLE_MAPS_API_KEY %>&libraries=places&callback=initEditMap">
</script>

<script>
  let map, marker, autocomplete;

  function initEditMap() {
    // Safely check whether coordinates exist
    const hasCoords = Number("<%= bar.latitude %>") && Number("<%= bar.longitude %>");

    const defaultLat = hasCoords ? Number("<%= bar.latitude %>") : 25.0375;
    const defaultLng = hasCoords ? Number("<%= bar.longitude %>") : 121.5637;
    const center = { lat: defaultLat, lng: defaultLng };

    // Initialize map
    map = new google.maps.Map(document.getElementById("map"), {
      center,
      zoom: hasCoords ? 15 : 12,
    });

    // Initialize marker
    marker = new google.maps.Marker({
      position: center,
      map: map,
      draggable: true,
      visible: hasCoords,
    });

    const latInput = document.getElementById("latitude");
    const lngInput = document.getElementById("longitude");

    // Google Places Autocomplete
    autocomplete = new google.maps.places.Autocomplete(
      document.getElementById("autocomplete"),
      { types: ["geocode"] }
    );

    // When the user selects a place
    autocomplete.addListener("place_changed", () => {
      const place = autocomplete.getPlace();
      if (!place.geometry) return;

      const loc = place.geometry.location;
      const lat = loc.lat();
      const lng = loc.lng();

      // Update map and form values
      map.setCenter({ lat, lng });
      map.setZoom(15);
      marker.setPosition({ lat, lng });
      marker.setVisible(true);

      latInput.value = lat;
      lngInput.value = lng;
    });

    // Update coordinates when marker is dragged
    marker.addListener("dragend", () => {
      const pos = marker.getPosition();
      latInput.value = pos.lat();
      lngInput.value = pos.lng();
    });
  }
</script>